\chapter{Conclusions}\label{cha:conclusions}

In this thesis we have presented our research to fullfil the requirements for \phd{} degree.
We have devised common usage patterns for the \java{} Unsafe \api{}.
We discussed several current and future alternatives to improve the
\java{} language.
This work has been published in~\citep{mastrangeloUseYourOwn2015}.
On the other hand, we complement our Unsafe \api{} study with 
our casting study.
We have submitted this study for publication to the \conf{OOPSLA}{19} conference.
We have devised common usage patterns that involve the cast operator.
Having a taxonomy of usage patterns---for both the Unsafe \api{} and casting---can shed light on how \java{} developers circumvent the static type system's constraints.

The \java{} language is evolving constantly.
There are several proposals to improve different aspects of the language.
The proposal JEP 193~\citep{jep193} that introduces Variable Handles is already accepted and included in \java{} 9.
The GC algorithm introduced in JEP 189 Shenandoah~\citep{jep189} is included as a experimental feature in \java{} 12.
There is an ongoing proposal%
\footnote{\url{https://openjdk.java.net/jeps/305}}$^{,}$%
\footnote{\url{https://cr.openjdk.java.net/~briangoetz/amber/pattern-match.html}}%
~\citep{jep305} to add pattern matching to the \java{} language.
The proposal explores changing the \code{instanceof} operator in order to support pattern matching.
\java{} 12 extends the \code{switch} statement to be used as either a statement or an expression%
\footnote{\url{https://openjdk.java.net/jeps/325}}$^{,}$%
\footnote{\url{https://openjdk.java.net/jeps/354}}~\citep{jep325,jep354}.
This enhancement aims to ease the transition to a \code{switch} expression that supports pattern matching.
On the other hand,
JEP 191 Foreign Function Interface~\citep{jep191},
JEP 169 Value Objects~\citep{jep169}, and
JEP 300 Augment Use-Site Variance with Declaration-Site Defaults~\citep{jep300}
are still in draft status.

\section*{\nameref*{cha:unsafe}}

\smu{} is an API that was designed for limited use in system-level runtime library code.
The \unsafe{} API is powerful, but dangerous.
The improper use of \unsafe{} undermines \java{}'s safety guarantees.
We studied to what degree \unsafe{} usage has spread into third-party libraries,
to what degree such third-party usage of \unsafe{} can impact existing Java code,
and which \unsafe{} API features such third-party libraries actually use.

We studied the questions and discussions developers have about \unsafe{},
and we identified common usage patterns.
We thereby provided a basis for evolving the \unsafe{} API, the \java{} language, and the \jvm{}
by eliminating unused or abused unsafe features,
and by providing safer alternatives for features that are used in meaningful ways.
We hope this will help to make \unsafe{} safer.

\section*{\nameref*{cha:casts}}

The cast operator in \java{} bridges the gap between compile-time and run-time safety.
We have devised several cast usage patterns.
We found the rationale behind some cast patterns is due to the inexpressiveness of \java{}'s type system.
On the other hand,
there are patterns that abuse or misuse it.

Many of the patterns we found should be unsurprising to most object-oriented programmers.
That nearly 45\% of casts are (possibly) unguarded 
suggests that developers use application-specific knowledge that cannot be easily encoded in
the type system to ensure the absence of run-time type errors.

Our study provides insight on the boundary between static and dynamic typing,
which may inform research on both static and dynamic,
as well as gradual type systems~\citep{Siek06gradualtyping}.
Conversely, this research can inform the design of extensions of the \java{} type system to reduce the need for casting.

We are currently working to define static analyses to detect some of these patterns automatically.
With these analyses,
tools can be developed to identify instances of the pattern and to ensure that they are being implemented properly.

\section*{Limitations and Future Work}

Both our \unsafe{} and casting studies rely on manual inspection to devise usage patterns.
We tried to use \ql{} to devise cast patterns.
However, \ql{}---and the \lgtm{} dataset---currently analyses a given project,
not its dependencies.
The main issue with manual inspection is that rely heavily on the personal experience of the authors.
Different authors could devise different set of patterns.

Conducting ultra-large scale studies, either on source code or compiled code, is not a trivial task.
There are several factors to consider when doing these kind of studies,
\eg{}, downloading, storing, parsing, compiling,
and analyzing software repositories.
Services like \boa{} and \lgtm{} make conducting these kind of studies easier.
In recent versions~\citep{boa-github},
\boa{} added support to conduct studies on open source projects from \github{} and Qualitas Corpus~\citep{temperoQualitasCorpusCurated2010}.
However, at the time we conducted our study on \unsafe{},
this support was not included yet.
We could recast our \unsafe{} study to use \boa{} on the \github{} dataset,
or \lgtm{} through \ql{} queries, although as mentioned above,
we will not be able to analyze project dependencies.
The patterns we have already devised for both the \unsafe{} and the casting study could be formalized using \ql{}~\citep{avgustinovQLObjectorientedQueries2016}.

To conduct our studies we have used static analysis.
Static analyses are always more conservative than dynamic analyses.
Another possible future direction could be complement the static analyses with dynamic ones.
For the \unsafe{} study,
we found that it is used in 1\% of the \mavencentral{} artifacts.
Using project dependencies, 25\% of artifacts depend on \smu{}.
A dynamic analysis could actually measure how often the \unsafe{} \api{} is invoked at run-time,
thus giving more precision about its usage.
As for the casting study,
using a dynamic analysis could measure how many casts fail with \code{ClassCastException}.

% What insights did you gain, can you summarize to what degree you answered the RQs?
