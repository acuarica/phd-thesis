\section{Cast Usage Patterns}
\label{sec:casts:patterns}

Using the methodology described in the above section,
we have devised \nPattern{} cast usage patterns.
Table~\ref{table:casts:patterns} presents our patterns and their
occurrences sorted by frequency.

\input{chapters/casts/table-casts-patterns-desc}
\input{chapters/casts/table-casts-patterns}

The patterns were arrived at by an iterative process.
Each sampled cast was assigned a pattern.
If no pattern fit the given cast,
a new pattern was invented and described.
The authors then discussed the patterns and their instances,
refining, merging, or splitting them into new patterns.
This was repeated until consensus among the authors was reached.
The particular categorization here is therefore subjective.

We initially sought to describe patterns precisely as \ql{} queries so that
detection and categorization was repeatable,
but we found this was infeasible because of the
complexity of the reasoning involved in identifying a pattern.
Often determining to which pattern a cast belongs
requires reasoning about the runtime source of the cast,
which might be non-local and might depend on external application
frameworks or generated code.

We do not claim that our list of patterns is exhaustive,
although our methodology should ensure that any pattern that occurs more
than 0.1\% of the time has a small probability of being excluded.

Moreover, we are interested in the scope of the cast instance,
\ie, \emph{does it appear in application/library code, test code, or generated code?}
Figure~\ref{fig:casts:patterns} shows our patterns and their occurrences grouped by scope and sorted by frequency.

\newcommand\plot[3]{
\begin{figure}[ht!]
\centering
\includegraphics[width=\textwidth]{analysis/#1.pdf}
\caption{#3} \label{#2}
\end{figure}
}

\plot{table-patterns}{fig:casts:patterns}{Cast Usage Pattern Occurrences}

Each pattern is described using the following template:

\begin{itemize}

\item \textit{Description.}
Tells what the pattern is about, gives a general overview of its structure, and
briefly describes the rationale behind how this pattern was characterized as such.
A few patterns can have distinct \emph{variants}, \ie,
different ways of implementing the pattern.
Whenever a pattern has variants,
we state how they differ from each other.

\item \textit{Instances.}
Gives one or more concrete examples found in real code.
The code snippets presented here were modified for formatting purposes.
Each example contains a highlighted line which shows the cast instance being inspected.
Moreover, to facilitate some snippet presentations,
we remove irrelevant code and replace it with the comment
\code{// [...]} or \code{/* [...] */} whenever convenient.
For each instance presented here,
we provide the link to the source code repository in \lgtm{}.
We provide the link in case the reader wants to do further inspection of the presented snippet.
Instead of presenting long \lgtm{} URLs,
we have used the URL shortening service
\href{https://bitly.com/}{\bitly} for easier reading.
Each \bitly{} link was customized to include the project name.
As we mentioned above, projects can be removed from the \lgtm{} service,
thus some links may not work.

\item \textit{Discussion.}
Discusses the reasons for the pattern, flaws, and alternatives that achieve the same goal without casting.

\end{itemize}


\newcommand\urlbox{\null\hfill\colorbox{lightgray}{\scriptsize\url{\urlvar}}}

\newcommand\castpatternsection[1]{\paragraph{#1.}}
\newcommand\variant[1]{\textsl{#1}}
\newenvironment{pattern}[1]{
    \newcommand{\nocc}{\csname n#1Pattern\endcsname{}}
    \newcommand{\noccsrc}{\csname n#1PatternSrc\endcsname{}}
    \newcommand{\noccgen}{\csname n#1PatternGen\endcsname{}}
    \newcommand{\nocctest}{\csname n#1PatternTest\endcsname{}}
    \newcommand{\pocc}{\csname p#1Pattern\endcsname{}}
    \newcommand{\instances}{\castpatternsection{Instances: \nocc{} (\pocc\%)}
    We found \noccsrc{} in application code, \nocctest{} in test code, and \noccgen{} in generated code.}
    \newcommand{\discussion}{\castpatternsection{Discussion}}
    \newcommand{\thisp}{\textsc{#1}}
    \subsection{\textsc{#1}}
    \label{pat:#1}
    \castpatternsection{Description}
}{}

\input{analysis/input-patterns.def}