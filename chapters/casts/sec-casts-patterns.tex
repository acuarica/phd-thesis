
\newcommand{\castpatternsection}[1]{\noindent\textbf{#1.}}
\newcommand{\pname}[1]{\textsc{#1}}
\newcommand{\group}[1]{

\

\

{\noindent\Large\textsc{#1} Patterns}

\

\begin{figure}[ht!]
\centering
\includegraphics[width=\textwidth]{"analysis/table-patterns-5000-by-group-#1"}
\caption{#1 Cast Pattern Occurrences}
\label{fig:group-patterns:#1}
\end{figure}

}

\newenvironment{pattern}[1]{
	\newcommand{\desc}{\castpatternsection{Description}}
	\newcommand{\instances}{\castpatternsection{Instances}}
	\newcommand{\detection}{\castpatternsection{Detection}}
	\newcommand{\discussion}{\castpatternsection{Discussion}}
	\newcommand{\related}{\castpatternsection{Related Patterns}}
    \newcommand{\thisp}{\textsc{#1}}
    \subsection{\pname{#1}}
    \label{pat:#1}
	\desc
}{}


\section{Cast Usage Patterns}
\label{sec:casts:patterns}

Using the methodology described in the above section,
we have devised \npattern{} cast usage patterns.
We have excluded casts that represent primitive numeric type conversions,
as they do not represent any pattern.
However, during our manual analysis we found \nprim{} primitive conversions.
Moreover, we found \nbrokenlinks{} links that were not accessible during our analysis.

In this section we present the cast usage patterns we found.
To ease the patterns presentation,
%
\todo{Nate: Overview of categories.}
\todo{Nate: Explain why each pattern belongs to a certain category.}
\todo{Nate: Try to lump together patterns into fewer categories.}
%
we have organized them into \ngroup{} categories according to their purpose.
Table~\ref{table:casts:patterns} presents each pattern and the groups they belong to.
Moreover, we are interested in the scope of the cast instance,
\ie, \emph{does it appear in application source code, test code, or generated code?}
%
\todo{Matthias: Add a paragraph describing and analyzing what one sees in that figure.}
%
Figure~\ref{fig:patterns} shows our patterns and their occurrences sorted by frequency.
The column on the right corresponds to the group the pattern belongs to.
\todo{Describe where patterns come from. Sample -> Invent patterns -> repeat.?}

\input{chapters/casts/table-patterns}

\clearpage

\begin{figure}[ht!]
\centering
\includegraphics[width=\textwidth]{analysis/table-patterns-5000.pdf}
\caption{Cast Pattern Occurrences} \label{fig:patterns}
\end{figure}

\discuss{Matthias: Start a new subsection here.}
\todo{Matthias: When describing each pattern, you may want to repeat the number of occurrences within the description {\scriptsize (maybe as part of the section title, or just below)}}
Each pattern is described using the following template:

\begin{itemize}
\item \textbf{Description.}
Tells what the pattern is about.
It gives a general overview of the structure of the pattern.
\item \textbf{Instances.}
Gives one or more concrete examples found in real code.
%
\done{Nate: What's the orange (hightlight color) mean? The line with the cast being inspected. Explain here}
%
Each example contains a highlighted line which shows the cast instance being inspected.
Please notice that the snippets presented here were slightly
modified for formatting purposes.
Moreover, to facilitate some snippet presentations,
we remove irrelevant code and replace it with the
comment \code{// [...]}.
For each instance presented here, we provide the link to the source code repository in \lgtm{}.
We provide the link in case the reader wants to do further inspection
of the presented snippet.
%
\done{Nate: List project name too.}
%
Instead of presenting \lgtm{} long URLs,
we have used the URL shortening service
\href{https://bitly.com/}{\bitly} for easier reading.
%
\done{Luis: Links were customized to include the project names.}
%
Each \bitly{} link was customized to include the project name.
\item \textbf{Detection.}
Describes briefly how this pattern was detected in terms of the tags introduced in the previous section.
\item \textbf{Discussion.}
Presents suggestions, flaws, or comments about the pattern.
\item \textbf{Related Patterns.}
%
\done{Nate: Remove "?"}
%
How the pattern being described relates to other patterns.
\end{itemize}

\group{Guarded}

\done{Matthias: Say what it means to be guarded.}
The patterns in this category are guarded casts.
A guarded cast is a cast such that before the cast is applied,
some condition --- the \emph{guard} -- needs to be verified.
The condition to be verified guarantees that the cast will not fail at runtime (unless there is a bug in the application), \ie,
the cast will not throw a \code{ClassCastException}.
Some kind of guards ensure that the cast will not fail at the language-level,
while others only can guarantee it at the application-level.

\input{chapters/casts/PatternMatching}
\input{chapters/casts/Equals}
\input{chapters/casts/TypeTag}
\input{chapters/casts/GetByClassLiteral}
\input{chapters/casts/StackSymbol}

\group{Creational}

\done{Matthias: In these paragraphs, can you also enumerate the patterns by name, so readers see what's coming?}
\done{Matthias: ???}
Creational patterns are cast instances that are determined by how the value being cast is created.

\input{chapters/casts/LookupById}
\input{chapters/casts/Factory}
\input{chapters/casts/Family}
\input{chapters/casts/Tag}
\input{chapters/casts/StaticResource}
\input{chapters/casts/NewDynamicInstance}
\input{chapters/casts/Deserialization}
\input{chapters/casts/CreateByClassLiteral}
\input{chapters/casts/Composite}

\group{Code Smell}

These are code smells.

\input{chapters/casts/Literal}
\input{chapters/casts/UseRawType}
\input{chapters/casts/Redundant}
\input{chapters/casts/KnownReturnType}
\input{chapters/casts/Clone}
\input{chapters/casts/VariableLessSpecificType}
\input{chapters/casts/ObjectAsArray}
\input{chapters/casts/AccessPrivateField}

\group{Resolution}

\input{chapters/casts/SelectOverload}
\input{chapters/casts/CovariantReturn}
\input{chapters/casts/ReflectiveAccessibility}
\input{chapters/casts/CovariantGeneric}

\group{Hierarchical}

\input{chapters/casts/SoleSubclassImplementation}
\input{chapters/casts/ImplicitIntersectionType}
\input{chapters/casts/RecursiveGeneric}

\group{Unchecked}

\input{chapters/casts/RemoveWildcard}
\input{chapters/casts/GenericArray}
\input{chapters/casts/UnoccupiedTypeParameter}
